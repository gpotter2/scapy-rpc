# SPDX-License-Identifier: GPL-2.0-only
# This file is part of Scapy RPC
# See https://scapy.net/ for more information
# Copyright (C) Gabriel Potter

# [ms-tsgu] v42.0 (Tue, 23 Apr 2024)

"""
RPC definitions for the following interfaces:
- TsProxyRpcInterface (v1.3): 44e265dd-7daf-42cd-8560-3cdb6e7a2729
This file is auto-generated by midl-to-scapy, do not modify.
"""

import uuid

from scapy.fields import StrFixedLenField
from scapy.layers.dcerpc import (
    NDRPacket,
    DceRpcOp,
    NDRConfFieldListField,
    NDRConfPacketListField,
    NDRConfStrLenField,
    NDRConfStrLenFieldUtf16,
    NDRConfVarStrLenField,
    NDRConfVarStrLenFieldUtf16,
    NDRContextHandle,
    NDRFullEmbPointerField,
    NDRFullPointerField,
    NDRIntField,
    NDRLongField,
    NDRPacketField,
    NDRShortField,
    NDRSignedByteField,
    NDRSignedIntField,
    NDRUnionField,
    register_dcerpc_interface,
)


class PTSG_PACKET_HEADER(NDRPacket):
    ALIGNMENT = (2, 2)
    fields_desc = [NDRShortField("ComponentId", 0), NDRShortField("PacketId", 0)]


class TSG_PACKET_HEADER(NDRPacket):
    ALIGNMENT = (2, 2)
    fields_desc = [NDRShortField("ComponentId", 0), NDRShortField("PacketId", 0)]


class TSG_CAPABILITY_NAP(NDRPacket):
    ALIGNMENT = (4, 4)
    fields_desc = [NDRIntField("capabilities", 0)]


class PTSG_PACKET_CAPABILITIES(NDRPacket):
    ALIGNMENT = (4, 4)
    fields_desc = [
        NDRIntField("capabilityType", 0),
        NDRUnionField(
            [
                (
                    NDRPacketField(
                        "TSGPacket", TSG_CAPABILITY_NAP(), TSG_CAPABILITY_NAP
                    ),
                    (
                        (lambda pkt: getattr(pkt, "capabilityType", None) == 1),
                        (lambda _, val: val.tag == 1),
                    ),
                )
            ],
            StrFixedLenField("TSGPacket", "", length=0),
            align=(4, 4),
            switch_fmt=("L", "L"),
        ),
    ]


class PTSG_PACKET_VERSIONCAPS(NDRPacket):
    ALIGNMENT = (4, 8)
    fields_desc = [
        NDRPacketField("tsgHeader", TSG_PACKET_HEADER(), TSG_PACKET_HEADER),
        NDRFullEmbPointerField(
            NDRConfPacketListField(
                "TSGCaps",
                [],
                PTSG_PACKET_CAPABILITIES,
                size_is=lambda pkt: pkt.numCapabilities,
            )
        ),
        NDRIntField("numCapabilities", None, size_of="TSGCaps"),
        NDRShortField("majorVersion", 0),
        NDRShortField("minorVersion", 0),
        NDRShortField("quarantineCapabilities", 0),
    ]


class PTSG_PACKET_QUARCONFIGREQUEST(NDRPacket):
    ALIGNMENT = (4, 4)
    fields_desc = [NDRIntField("flags", 0)]


class PTSG_PACKET_QUARREQUEST(NDRPacket):
    ALIGNMENT = (4, 8)
    fields_desc = [
        NDRIntField("flags", 0),
        NDRFullEmbPointerField(
            NDRConfVarStrLenFieldUtf16(
                "machineName", "", size_is=lambda pkt: pkt.nameLength
            )
        ),
        NDRIntField("nameLength", None, size_of="machineName"),
        NDRFullEmbPointerField(
            NDRConfStrLenField("data", "", size_is=lambda pkt: pkt.dataLen)
        ),
        NDRIntField("dataLen", None, size_of="data"),
    ]


class TSG_REDIRECTION_FLAGS(NDRPacket):
    ALIGNMENT = (4, 4)
    fields_desc = [
        NDRSignedIntField("enableAllRedirections", 0),
        NDRSignedIntField("disableAllRedirections", 0),
        NDRSignedIntField("driveRedirectionDisabled", 0),
        NDRSignedIntField("printerRedirectionDisabled", 0),
        NDRSignedIntField("portRedirectionDisabled", 0),
        NDRSignedIntField("reserved", 0),
        NDRSignedIntField("clipboardRedirectionDisabled", 0),
        NDRSignedIntField("pnpRedirectionDisabled", 0),
    ]


class PTSG_PACKET_RESPONSE(NDRPacket):
    ALIGNMENT = (4, 8)
    fields_desc = [
        NDRIntField("flags", 0),
        NDRIntField("reserved", 0),
        NDRFullEmbPointerField(
            NDRConfStrLenField(
                "responseData", "", size_is=lambda pkt: pkt.responseDataLen
            )
        ),
        NDRIntField("responseDataLen", None, size_of="responseData"),
        NDRPacketField(
            "redirectionFlags", TSG_REDIRECTION_FLAGS(), TSG_REDIRECTION_FLAGS
        ),
    ]


class GUID(NDRPacket):
    ALIGNMENT = (4, 4)
    fields_desc = [
        NDRIntField("Data1", 0),
        NDRShortField("Data2", 0),
        NDRShortField("Data3", 0),
        StrFixedLenField("Data4", "", length=8),
    ]


class PTSG_PACKET_QUARENC_RESPONSE(NDRPacket):
    ALIGNMENT = (4, 8)
    fields_desc = [
        NDRIntField("flags", 0),
        NDRIntField("certChainLen", None, size_of="certChainData"),
        NDRFullEmbPointerField(
            NDRConfVarStrLenFieldUtf16(
                "certChainData", "", size_is=lambda pkt: pkt.certChainLen
            )
        ),
        NDRPacketField("nonce", GUID(), GUID),
        NDRFullEmbPointerField(
            NDRPacketField(
                "versionCaps", PTSG_PACKET_VERSIONCAPS(), PTSG_PACKET_VERSIONCAPS
            )
        ),
    ]


class TSG_PACKET_QUARENC_RESPONSE(NDRPacket):
    ALIGNMENT = (4, 8)
    fields_desc = [
        NDRIntField("flags", 0),
        NDRIntField("certChainLen", None, size_of="certChainData"),
        NDRFullEmbPointerField(
            NDRConfVarStrLenFieldUtf16(
                "certChainData", "", size_is=lambda pkt: pkt.certChainLen
            )
        ),
        NDRPacketField("nonce", GUID(), GUID),
        NDRFullEmbPointerField(
            NDRPacketField(
                "versionCaps", PTSG_PACKET_VERSIONCAPS(), PTSG_PACKET_VERSIONCAPS
            )
        ),
    ]


class PTSG_PACKET_STRING_MESSAGE(NDRPacket):
    ALIGNMENT = (4, 8)
    fields_desc = [
        NDRSignedIntField("isDisplayMandatory", 0),
        NDRSignedIntField("isConsentMandatory", 0),
        NDRIntField("msgBytes", None, size_of="msgBuffer"),
        NDRFullEmbPointerField(
            NDRConfStrLenFieldUtf16("msgBuffer", "", size_is=lambda pkt: pkt.msgBytes)
        ),
    ]


class PTSG_PACKET_REAUTH_MESSAGE(NDRPacket):
    ALIGNMENT = (8, 8)
    fields_desc = [NDRLongField("tunnelContext", 0)]


class TSG_PACKET_MSG_RESPONSE(NDRPacket):
    ALIGNMENT = (4, 8)
    fields_desc = [
        NDRIntField("msgID", 0),
        NDRIntField("msgType", 0),
        NDRSignedIntField("isMsgPresent", 0),
        NDRUnionField(
            [
                (
                    NDRFullEmbPointerField(
                        NDRPacketField(
                            "messagePacket",
                            PTSG_PACKET_STRING_MESSAGE(),
                            PTSG_PACKET_STRING_MESSAGE,
                        )
                    ),
                    (
                        (lambda pkt: getattr(pkt, "msgType", None) == 1),
                        (lambda _, val: val.tag == 1),
                    ),
                ),
                (
                    NDRFullEmbPointerField(
                        NDRPacketField(
                            "messagePacket",
                            PTSG_PACKET_STRING_MESSAGE(),
                            PTSG_PACKET_STRING_MESSAGE,
                        )
                    ),
                    (
                        (lambda pkt: getattr(pkt, "msgType", None) == 2),
                        (lambda _, val: val.tag == 2),
                    ),
                ),
                (
                    NDRFullEmbPointerField(
                        NDRPacketField(
                            "messagePacket",
                            PTSG_PACKET_REAUTH_MESSAGE(),
                            PTSG_PACKET_REAUTH_MESSAGE,
                        )
                    ),
                    (
                        (lambda pkt: getattr(pkt, "msgType", None) == 3),
                        (lambda _, val: val.tag == 3),
                    ),
                ),
            ],
            StrFixedLenField("messagePacket", "", length=0),
            align=(4, 8),
            switch_fmt=("L", "L"),
        ),
    ]


class PTSG_PACKET_CAPS_RESPONSE(NDRPacket):
    ALIGNMENT = (4, 8)
    fields_desc = [
        NDRPacketField(
            "pktQuarEncResponse",
            TSG_PACKET_QUARENC_RESPONSE(),
            TSG_PACKET_QUARENC_RESPONSE,
        ),
        NDRPacketField(
            "pktConsentMessage", TSG_PACKET_MSG_RESPONSE(), TSG_PACKET_MSG_RESPONSE
        ),
    ]


class PTSG_PACKET_MSG_REQUEST(NDRPacket):
    ALIGNMENT = (4, 4)
    fields_desc = [NDRIntField("maxMessagesPerBatch", 0)]


class PTSG_PACKET_MSG_RESPONSE(NDRPacket):
    ALIGNMENT = (4, 8)
    fields_desc = [
        NDRIntField("msgID", 0),
        NDRIntField("msgType", 0),
        NDRSignedIntField("isMsgPresent", 0),
        NDRUnionField(
            [
                (
                    NDRFullEmbPointerField(
                        NDRPacketField(
                            "messagePacket",
                            PTSG_PACKET_STRING_MESSAGE(),
                            PTSG_PACKET_STRING_MESSAGE,
                        )
                    ),
                    (
                        (lambda pkt: getattr(pkt, "msgType", None) == 1),
                        (lambda _, val: val.tag == 1),
                    ),
                ),
                (
                    NDRFullEmbPointerField(
                        NDRPacketField(
                            "messagePacket",
                            PTSG_PACKET_STRING_MESSAGE(),
                            PTSG_PACKET_STRING_MESSAGE,
                        )
                    ),
                    (
                        (lambda pkt: getattr(pkt, "msgType", None) == 2),
                        (lambda _, val: val.tag == 2),
                    ),
                ),
                (
                    NDRFullEmbPointerField(
                        NDRPacketField(
                            "messagePacket",
                            PTSG_PACKET_REAUTH_MESSAGE(),
                            PTSG_PACKET_REAUTH_MESSAGE,
                        )
                    ),
                    (
                        (lambda pkt: getattr(pkt, "msgType", None) == 3),
                        (lambda _, val: val.tag == 3),
                    ),
                ),
            ],
            StrFixedLenField("messagePacket", "", length=0),
            align=(4, 8),
            switch_fmt=("L", "L"),
        ),
    ]


class TSG_PACKET_VERSIONCAPS(NDRPacket):
    ALIGNMENT = (4, 8)
    fields_desc = [
        NDRPacketField("tsgHeader", TSG_PACKET_HEADER(), TSG_PACKET_HEADER),
        NDRFullEmbPointerField(
            NDRConfPacketListField(
                "TSGCaps",
                [],
                PTSG_PACKET_CAPABILITIES,
                size_is=lambda pkt: pkt.numCapabilities,
            )
        ),
        NDRIntField("numCapabilities", None, size_of="TSGCaps"),
        NDRShortField("majorVersion", 0),
        NDRShortField("minorVersion", 0),
        NDRShortField("quarantineCapabilities", 0),
    ]


class PTSG_PACKET_AUTH(NDRPacket):
    ALIGNMENT = (4, 8)
    fields_desc = [
        NDRPacketField(
            "TSGVersionCaps", TSG_PACKET_VERSIONCAPS(), TSG_PACKET_VERSIONCAPS
        ),
        NDRIntField("cookieLen", None, size_of="cookie"),
        NDRFullEmbPointerField(
            NDRConfStrLenField("cookie", "", size_is=lambda pkt: pkt.cookieLen)
        ),
    ]


class PTSG_PACKET_REAUTH(NDRPacket):
    ALIGNMENT = (8, 8)
    fields_desc = [
        NDRLongField("tunnelContext", 0),
        NDRIntField("packetId", 0),
        NDRUnionField(
            [
                (
                    NDRFullEmbPointerField(
                        NDRPacketField(
                            "TSGInitialPacket",
                            PTSG_PACKET_VERSIONCAPS(),
                            PTSG_PACKET_VERSIONCAPS,
                        )
                    ),
                    (
                        (lambda pkt: getattr(pkt, "packetId", None) == 22083),
                        (lambda _, val: val.tag == 22083),
                    ),
                ),
                (
                    NDRFullEmbPointerField(
                        NDRPacketField(
                            "TSGInitialPacket", PTSG_PACKET_AUTH(), PTSG_PACKET_AUTH
                        )
                    ),
                    (
                        (lambda pkt: getattr(pkt, "packetId", None) == 16468),
                        (lambda _, val: val.tag == 16468),
                    ),
                ),
            ],
            StrFixedLenField("TSGInitialPacket", "", length=0),
            align=(4, 8),
            switch_fmt=("L", "L"),
        ),
    ]


class PTSG_PACKET(NDRPacket):
    ALIGNMENT = (4, 8)
    fields_desc = [
        NDRIntField("packetId", 0),
        NDRUnionField(
            [
                (
                    NDRFullEmbPointerField(
                        NDRPacketField(
                            "TSGPacket", PTSG_PACKET_HEADER(), PTSG_PACKET_HEADER
                        )
                    ),
                    (
                        (lambda pkt: getattr(pkt, "packetId", None) == 18500),
                        (lambda _, val: val.tag == 18500),
                    ),
                ),
                (
                    NDRFullEmbPointerField(
                        NDRPacketField(
                            "TSGPacket",
                            PTSG_PACKET_VERSIONCAPS(),
                            PTSG_PACKET_VERSIONCAPS,
                        )
                    ),
                    (
                        (lambda pkt: getattr(pkt, "packetId", None) == 22083),
                        (lambda _, val: val.tag == 22083),
                    ),
                ),
                (
                    NDRFullEmbPointerField(
                        NDRPacketField(
                            "TSGPacket",
                            PTSG_PACKET_QUARCONFIGREQUEST(),
                            PTSG_PACKET_QUARCONFIGREQUEST,
                        )
                    ),
                    (
                        (lambda pkt: getattr(pkt, "packetId", None) == 20803),
                        (lambda _, val: val.tag == 20803),
                    ),
                ),
                (
                    NDRFullEmbPointerField(
                        NDRPacketField(
                            "TSGPacket",
                            PTSG_PACKET_QUARREQUEST(),
                            PTSG_PACKET_QUARREQUEST,
                        )
                    ),
                    (
                        (lambda pkt: getattr(pkt, "packetId", None) == 20818),
                        (lambda _, val: val.tag == 20818),
                    ),
                ),
                (
                    NDRFullEmbPointerField(
                        NDRPacketField(
                            "TSGPacket", PTSG_PACKET_RESPONSE(), PTSG_PACKET_RESPONSE
                        )
                    ),
                    (
                        (lambda pkt: getattr(pkt, "packetId", None) == 20562),
                        (lambda _, val: val.tag == 20562),
                    ),
                ),
                (
                    NDRFullEmbPointerField(
                        NDRPacketField(
                            "TSGPacket",
                            PTSG_PACKET_QUARENC_RESPONSE(),
                            PTSG_PACKET_QUARENC_RESPONSE,
                        )
                    ),
                    (
                        (lambda pkt: getattr(pkt, "packetId", None) == 17746),
                        (lambda _, val: val.tag == 17746),
                    ),
                ),
                (
                    NDRFullEmbPointerField(
                        NDRPacketField(
                            "TSGPacket",
                            PTSG_PACKET_CAPS_RESPONSE(),
                            PTSG_PACKET_CAPS_RESPONSE,
                        )
                    ),
                    (
                        (lambda pkt: getattr(pkt, "packetId", None) == 17232),
                        (lambda _, val: val.tag == 17232),
                    ),
                ),
                (
                    NDRFullEmbPointerField(
                        NDRPacketField(
                            "TSGPacket",
                            PTSG_PACKET_MSG_REQUEST(),
                            PTSG_PACKET_MSG_REQUEST,
                        )
                    ),
                    (
                        (lambda pkt: getattr(pkt, "packetId", None) == 18258),
                        (lambda _, val: val.tag == 18258),
                    ),
                ),
                (
                    NDRFullEmbPointerField(
                        NDRPacketField(
                            "TSGPacket",
                            PTSG_PACKET_MSG_RESPONSE(),
                            PTSG_PACKET_MSG_RESPONSE,
                        )
                    ),
                    (
                        (lambda pkt: getattr(pkt, "packetId", None) == 18256),
                        (lambda _, val: val.tag == 18256),
                    ),
                ),
                (
                    NDRFullEmbPointerField(
                        NDRPacketField(
                            "TSGPacket", PTSG_PACKET_AUTH(), PTSG_PACKET_AUTH
                        )
                    ),
                    (
                        (lambda pkt: getattr(pkt, "packetId", None) == 16468),
                        (lambda _, val: val.tag == 16468),
                    ),
                ),
                (
                    NDRFullEmbPointerField(
                        NDRPacketField(
                            "TSGPacket", PTSG_PACKET_REAUTH(), PTSG_PACKET_REAUTH
                        )
                    ),
                    (
                        (lambda pkt: getattr(pkt, "packetId", None) == 21072),
                        (lambda _, val: val.tag == 21072),
                    ),
                ),
            ],
            StrFixedLenField("TSGPacket", "", length=0),
            align=(4, 8),
            switch_fmt=("L", "L"),
        ),
    ]


class TsProxyCreateTunnel_Request(NDRPacket):
    fields_desc = [NDRPacketField("TSGPacket", PTSG_PACKET(), PTSG_PACKET)]


class TsProxyCreateTunnel_Response(NDRPacket):
    fields_desc = [
        NDRFullPointerField(
            NDRPacketField("TSGPacketResponse", PTSG_PACKET(), PTSG_PACKET)
        ),
        NDRPacketField("tunnelContext", NDRContextHandle(), NDRContextHandle),
        NDRIntField("tunnelId", 0),
        NDRIntField("status", 0),
    ]


class TsProxyAuthorizeTunnel_Request(NDRPacket):
    fields_desc = [
        NDRPacketField("tunnelContext", NDRContextHandle(), NDRContextHandle),
        NDRPacketField("TSGPacket", PTSG_PACKET(), PTSG_PACKET),
    ]


class TsProxyAuthorizeTunnel_Response(NDRPacket):
    fields_desc = [
        NDRFullPointerField(
            NDRPacketField("TSGPacketResponse", PTSG_PACKET(), PTSG_PACKET)
        ),
        NDRIntField("status", 0),
    ]


class TsProxyMakeTunnelCall_Request(NDRPacket):
    fields_desc = [
        NDRPacketField("tunnelContext", NDRContextHandle(), NDRContextHandle),
        NDRIntField("procId", 0),
        NDRPacketField("TSGPacket", PTSG_PACKET(), PTSG_PACKET),
    ]


class TsProxyMakeTunnelCall_Response(NDRPacket):
    fields_desc = [
        NDRFullPointerField(
            NDRPacketField("TSGPacketResponse", PTSG_PACKET(), PTSG_PACKET)
        ),
        NDRIntField("status", 0),
    ]


class PTSENDPOINTINFO(NDRPacket):
    ALIGNMENT = (4, 8)
    fields_desc = [
        NDRFullEmbPointerField(
            NDRConfVarStrLenFieldUtf16(
                "resourceName", "", size_is=lambda pkt: pkt.numResourceNames
            )
        ),
        NDRIntField("numResourceNames", None, size_of="resourceName"),
        NDRFullEmbPointerField(
            NDRConfVarStrLenFieldUtf16(
                "alternateResourceNames",
                "",
                size_is=lambda pkt: pkt.numAlternateResourceNames,
            )
        ),
        NDRShortField(
            "numAlternateResourceNames", None, size_of="alternateResourceNames"
        ),
        NDRIntField("Port", 0),
    ]


class TsProxyCreateChannel_Request(NDRPacket):
    fields_desc = [
        NDRPacketField("tunnelContext", NDRContextHandle(), NDRContextHandle),
        NDRPacketField("tsEndPointInfo", PTSENDPOINTINFO(), PTSENDPOINTINFO),
    ]


class TsProxyCreateChannel_Response(NDRPacket):
    fields_desc = [
        NDRPacketField("channelContext", NDRContextHandle(), NDRContextHandle),
        NDRIntField("channelId", 0),
        NDRIntField("status", 0),
    ]


class TsProxyCloseChannel_Request(NDRPacket):
    fields_desc = [NDRPacketField("context", NDRContextHandle(), NDRContextHandle)]


class TsProxyCloseChannel_Response(NDRPacket):
    fields_desc = [
        NDRPacketField("context", NDRContextHandle(), NDRContextHandle),
        NDRIntField("status", 0),
    ]


class TsProxyCloseTunnel_Request(NDRPacket):
    fields_desc = [NDRPacketField("context", NDRContextHandle(), NDRContextHandle)]


class TsProxyCloseTunnel_Response(NDRPacket):
    fields_desc = [
        NDRPacketField("context", NDRContextHandle(), NDRContextHandle),
        NDRIntField("status", 0),
    ]


class TsProxySetupReceivePipe_Request(NDRPacket):
    fields_desc = [
        NDRConfFieldListField(
            "pRpcMessage", [], NDRSignedByteField("", 0), size_is=lambda pkt: 32767
        )
    ]


class TsProxySetupReceivePipe_Response(NDRPacket):
    fields_desc = [NDRIntField("status", 0)]


class TsProxySendToServer_Request(NDRPacket):
    fields_desc = [
        NDRConfFieldListField(
            "pRpcMessage", [], NDRSignedByteField("", 0), size_is=lambda pkt: 32767
        )
    ]


class TsProxySendToServer_Response(NDRPacket):
    fields_desc = [NDRIntField("status", 0)]


TSPROXYRPCINTERFACE_OPNUMS = {  # 0: Opnum0NotUsedOnWire,
    1: DceRpcOp(TsProxyCreateTunnel_Request, TsProxyCreateTunnel_Response),
    2: DceRpcOp(TsProxyAuthorizeTunnel_Request, TsProxyAuthorizeTunnel_Response),
    3: DceRpcOp(TsProxyMakeTunnelCall_Request, TsProxyMakeTunnelCall_Response),
    4: DceRpcOp(TsProxyCreateChannel_Request, TsProxyCreateChannel_Response),
    # 5: Opnum5NotUsedOnWire,
    6: DceRpcOp(TsProxyCloseChannel_Request, TsProxyCloseChannel_Response),
    7: DceRpcOp(TsProxyCloseTunnel_Request, TsProxyCloseTunnel_Response),
    8: DceRpcOp(TsProxySetupReceivePipe_Request, TsProxySetupReceivePipe_Response),
    9: DceRpcOp(TsProxySendToServer_Request, TsProxySendToServer_Response),
}
register_dcerpc_interface(
    name="TsProxyRpcInterface",
    uuid=uuid.UUID("44e265dd-7daf-42cd-8560-3cdb6e7a2729"),
    version="1.3",
    opnums=TSPROXYRPCINTERFACE_OPNUMS,
)
